<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Alien Checkpoint</title>
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0b0f1a; --panel:#0f1626; --ink:#e6f0ff; --muted:#9ab; --accent:#66e; --warn:#ffbe0b; --bad:#ef4444; --good:#22c55e; --paper:#f7f4e8; --inkpaper:#1e293b; --border:#1f2a44;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0a0d17 60%);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:#0e1422;border:1px solid var(--border);border-radius:14px;position:sticky;top:0;z-index:10;backdrop-filter:blur(6px)}
  header h1{font-size:18px;margin:0 8px 0 0;letter-spacing:.6px}
  .stat{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#0b1220;border:1px solid var(--border);border-radius:10px}
  .stat b{font-weight:700}
  .grow{flex:1}
  .btn{appearance:none;border:1px solid var(--border);background:#121a2b;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;transition:transform .05s ease,background .2s}
  .btn:hover{background:#141f34}
  .btn:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:360px 1fr 360px;gap:14px;margin-top:14px}
  .panel{background:#0f1626;border:1px solid var(--border);border-radius:14px;overflow:hidden}
  .panel h2{margin:0;padding:10px 12px;background:#0c1220;border-bottom:1px solid var(--border);font-size:14px;color:#cde;text-transform:uppercase;letter-spacing:.7px}
  .pad{padding:12px}
  .queue{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
  .alienCard{display:flex;gap:10px;align-items:center;padding:10px;background:#10192d;border:1px dashed #233355;border-radius:12px}
  .alienPic{width:54px;height:54px;border-radius:10px;background:#091225;display:grid;place-items:center;overflow:hidden}
  .alienMeta{font-size:12px;color:var(--muted)}
  .workspace{display:grid;grid-template-columns:1fr;gap:10px}
  .desk{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .doc{background:var(--paper);color:var(--inkpaper);border:2px solid #c9c4b4;border-radius:10px;box-shadow:0 1px 0 #0004 inset, 0 8px 30px #0005;padding:10px;position:relative;min-height:160px}
  .doc h3{margin:0 0 6px;font:700 14px ui-monospace,Consolas,monospace;letter-spacing:.4px}
  .doc table{width:100%;border-collapse:collapse;font:13px ui-monospace,Consolas,monospace}
  .doc td{padding:4px 6px;border-bottom:1px dashed #d7d2c2}
  .doc td:first-child{width:44%}
  .doc td.illegible{filter:blur(1.2px);text-shadow:0 0 2px rgba(0,0,0,.25);}
  .stamp{position:absolute;inset:auto auto 10px 10px;padding:6px 10px;border:3px solid #b33;border-radius:8px;color:#b33;font:700 16px ui-monospace,Consolas,monospace;transform:rotate(-6deg);opacity:0;pointer-events:none}
  .stamp.ok{border-color:#1d7c3a;color:#1d7c3a}
  .tools{display:flex;gap:10px}
  .hammer{background:#0d172a;border:1px solid var(--border);border-radius:12px;padding:10px}
  .big{display:flex;gap:10px}
  .big .btn{font-size:16px;padding:12px 14px}
  .rule{padding:10px;border-bottom:1px dashed #2a3b6b}
  .rule:last-child{border-bottom:none}
  .rule b{color:#cfe1ff}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:10px;align-items:center}
  .money{color:#86efac}
  .strike{color:#fecaca}
  .log{max-height:180px;overflow:auto;background:#0b1220;border:1px solid var(--border);border-radius:10px;padding:8px;font:12px ui-monospace,Consolas,monospace}
  .log p{margin:0 0 6px}
  .switches{display:flex;gap:8px;flex-wrap:wrap}
  .chip{font:12px ui-monospace,Consolas,monospace;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0c1322}
  .right{display:flex;flex-direction:column;gap:10px}
  .footer{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:var(--muted)}
  .kbd{font:600 12px ui-monospace,Consolas,monospace;background:#0c1322;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
  .toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#0f1626;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:0 10px 30px #0007;display:none}
  .rank{font-weight:700}
  .progress{height:8px;background:#12203a;border-radius:999px;overflow:hidden}
  .progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2dd4bf,#60a5fa)}
  .help{font-size:13px;color:#cbd5e1}
  .disclaimer{font-size:12px;color:#8ea3c7}
  .photo{display:grid;grid-template-columns:72px 1fr;gap:8px;align-items:center}
  /* Passport portrait bigger */
  #passport .photo{grid-template-columns:110px 1fr; align-items:start}
  #passport .photo img{width:100px;height:100px}
  #pp-feats{word-break:break-word;overflow-wrap:anywhere}
  #passport .photo img, #photoid .photo img{object-fit:contain;background:white}
  .photo img{width:72px;height:72px;border-radius:8px;border:2px solid #c9c4b4;background:white}
  .faceRow{display:flex;gap:6px;flex-wrap:wrap;font:12px ui-monospace,Consolas,monospace}
  /* Make main columns scrollable within the viewport */
  .panel{ max-height: calc(100vh - 160px); overflow: auto; }
  @media (max-width: 1200px){ .grid{ grid-template-columns: 280px 1fr 300px; } }
  @media (max-width: 1000px){ .grid{ grid-template-columns: 1fr; } .desk{ grid-template-columns: 1fr; } .panel{ max-height: none; } }
</style>
<style id=\"compact-overrides\">
  /* Compact, no-scroll overrides */
  html,body{overflow-x:hidden}
  body{font-size:13px;line-height:1.4}
  .wrap{max-width:1200px;padding:8px}
  header{padding:8px 10px}
  header h1{font-size:16px}
  .stat{padding:4px 8px}
  .grid{height:calc(100vh - 88px);grid-template-columns:300px 1fr 300px;gap:8px}
  .panel{max-height:unset;overflow:hidden}
  .queue{gap:6px}
  #queue{height:calc(100% - 40px)}
  .alienCard{padding:6px}
  .alienPic{width:46px;height:46px}
  .desk{grid-template-columns:1fr 1fr;gap:8px}
  .doc{padding:8px}
  .doc h3{font-size:12px}
  .doc table{font-size:12px}
  .photo{grid-template-columns:68px 1fr}
  /* Keep passport photo wide enough in compact mode too */
  #passport .photo{grid-template-columns:110px 1fr}
  #passport .photo img{width:100px;height:100px}
  .tools{gap:6px}
  .log{height:90px;overflow:hidden}
  .rule{padding:6px}
  .progress{height:6px}

  /* Auto mobile layout */
  @media (max-width: 820px){
    .grid{grid-template-columns:1fr;height:auto}
    .panel{max-height:none;overflow:visible}
    .desk{grid-template-columns:1fr}
    header{flex-wrap:wrap;gap:6px}
    .stat{padding:2px 6px;font-size:12px}
    .btn{padding:6px 8px;font-size:12px}
  }

  /* Phone-friendly sticky action bar */
  @media (max-width: 900px){
    .tools.big{position:sticky;bottom:0;left:0;right:0;background:#0f1626CC;border-top:1px solid var(--border);backdrop-filter:blur(6px);padding:8px;z-index:5}
    .tools.big .btn{flex:1;min-height:44px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Alien Checkpoint</h1>
      <div class="stat"><b>Date:</b> <span id="ui-date">—</span></div>
      <div class="stat"><b>Day:</b> <span id="ui-day">1</span></div>
      <div class="stat"><b>Credits:</b> <span id="ui-credits" class="money">0</span></div>
      <div class="stat"><b>Strikes:</b> <span id="ui-strikes" class="strike">0</span></div>
      <div class="stat"><b>Rank:</b> <span id="ui-rank" class="rank">Recruit</span></div>
      <div class="grow"></div>
      <button class="btn" id="btn-manual" title="Training manual">Training Manual</button>
      <button class="btn" id="btn-shop" title="Buy upgrades with credits">Upgrades</button>
      <button class="btn" id="btn-newday" title="Start/End Day (Space)">Start Day</button>
      <button class="btn" id="btn-reset" title="Reset save">Reset</button>
    </header>

    <div class="grid">
      <section class="panel">
        <h2>Docking Queue</h2>
        <div class="pad queue" id="queue"></div>
      </section>

      <section class="panel workspace">
        <h2>Inspection Desk</h2>
        <div class="pad desk">
          <div class="doc" id="passport">
            <h3>INTERSTELLAR PASSPORT</h3>
            <div class="photo" style="margin-bottom:6px">
              <img id="pp-live" alt="Live portrait" />
              <div class="faceRow" id="pp-feats">—</div>
            </div>
            <table>
              <tr><td>Species</td><td id="pp-species">—</td></tr>
              <tr><td>Name</td><td id="pp-name">—</td></tr>
              <tr><td>Planet of Origin</td><td id="pp-planet">—</td></tr>
              <tr><td>Birth Cycle</td><td id="pp-dob">—</td></tr>
              <tr><td>Expires</td><td id="pp-exp">—</td></tr>
              <tr><td>Genetic Key</td><td id="pp-gk">—</td></tr>
            </table>
            <div class="hammer" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <button class="btn" id="scan-gk">Scan Genetic Key</button>
            </div>
            <div class="stamp" id="pp-stamp">DENIED</div>
          </div>
          <div class="doc" id="visa">
            <h3>DOCKING VISA</h3>
            <table>
              <tr><td>Name</td><td id="vs-name">—</td></tr>
              <tr><td>Purpose</td><td id="vs-purpose">—</td></tr>
              <tr><td>Duration</td><td id="vs-duration">—</td></tr>
              <tr><td>Planet Permit</td><td id="vs-planet">—</td></tr>
              <tr><td>Quarantine</td><td id="vs-quar">—</td></tr>
              <tr><td>Seal Code</td><td id="vs-seal">—</td></tr>
            </table>
            <div class="stamp ok" id="vs-stamp">APPROVED</div>
          </div>
          <div class="doc" id="photoid">
            <h3>PHOTO IDENTIFICATION</h3>
            <div class="photo">
              <img id="pid-photo" alt="Recorded photo" />
              <div>
                <div id="pid-name" style="font-weight:700">—</div>
                <div id="pid-caption" class="muted">Dockyard archive photo on arrival</div>
                <div class="faceRow" id="pid-feats">—</div>
              </div>
            </div>
            <div class="stamp" id="pid-stamp">MISMATCH</div>
          </div>
        </div>
        <div class="pad">
          <div class="hammer" id="wanted-db" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
            <b style="font:600 13px ui-monospace,Consolas,monospace">Wanted Database</b>
            <input id="manual-gk" class="btn" style="background:#0b1220;border-style:dashed;min-width:240px" placeholder="Type or paste genetic code (GK######)" />
            <button class="btn" id="check-gk">Check</button>
            <span class="muted">(Auto-filled after scanning)</span>
          </div>
          <div class="tools big">
            <button class="btn" id="approve">APPROVE (A)</button>
            <button class="btn" id="deny">DENY (D)</button>
            <button class="btn" id="detain">DETAIN (F)</button>
            <button class="btn" id="next">NEXT SHIP (N)</button>
          </div>
          <div class="footer">
            <div class="switches">
              <span class="chip">Tip: Click a doc to reveal hidden stamps if forged</span>
              <span class="chip">Shortcuts: <span class="kbd">A</span>/<span class="kbd">D</span>/<span class="kbd">F</span>/<span class="kbd">N</span>, <span class="kbd">Space</span> for Start/End Day</span>
            </div>
          </div>
        </div>
        <div class="pad">
          <div class="log" id="log"></div>
        </div>
      </section>

      <section class="panel right">
        <h2>Regulations & Progress</h2>
        <div class="pad" id="rules"></div>
        <div class="pad">
          <div class="help">Ensure names match on <b>Passport</b>, <b>Visa</b>, and <b>Photo ID</b> and are legible. Scan or manually check genetic keys against the wanted registry. Visa seals must be <code>NX-###</code>. Passport must be unexpired relative to today.</div>
        </div>
        <div class="pad">
          <div>Progress to next rank</div>
          <div class="progress"><i id="xpbar"></i></div>
          <div class="disclaimer" style="margin-top:8px">Inspired by border-control puzzle games. Original parody mechanics—no copyrighted assets.</div>
        </div>
      </section>
    </div>

    <!-- Lightbox for zooming portraits -->
    <div id="lightbox" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:999;align-items:center;justify-content:center;">
      <img id="lightbox-img" alt="zoom" style="max-width:90vw;max-height:90vh;border-radius:12px;background:white;border:2px solid #c9c4b4" />
    </div>

    <!-- Training Manual Modal -->
    <div class="modal" id="manual" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999">
      <div class="modalCard" style="width:min(880px,92vw);max-height:80vh;background:#0f1626;border:1px solid #1f2a44;border-radius:12px;box-shadow:0 18px 60px #000a;display:flex;flex-direction:column">
        <div class="modalHead" style="display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #1f2a44">
          <strong>Training Manual</strong>
          <button class="closeX" id="manual-close" style="cursor:pointer;border:1px solid #1f2a44;border-radius:8px;background:#121a2b;padding:4px 8px;color:#e6f0ff">✕</button>
        </div>
        <div class="modalBody" style="padding:12px;overflow:auto;color:#cfe1ff">
          <h4 style="margin:0 0 6px">When to Approve / Deny / Detain</h4>
          <ul>
            <li><b>APPROVE</b>: All documents valid and matching; seal <code>NX-###</code>; passport unexpired.</li>
            <li><b>DENY</b>: Document problems — illegible or mismatched names, invalid seal format, expired passport, or photo features don’t match.</li>
            <li><b>DETAIN</b>: Genetic key flagged as <u>wanted</u> (scanner or database) <i>or</i> Visa quarantine is <b>Level‑2</b> or <b>Biohazard</b>.</li>
          </ul>
          <h4>Seal Examples</h4>
          <p><b>Valid:</b> <code>NX-123</code>. <b>Invalid:</b> <code>NX123</code>, <code>NQ-123</code>, <code>NX-1234</code>, <code>NX-12a</code>.</p>
          <h4>Planet of Origin vs Planet Permit</h4>
          <p>The planet on the <b>Passport</b> must match the <b>Planet Permit</b> on the <b>Visa</b>. If they differ, that is a document failure (DENY unless detention rules apply).</p>
          <p>Use <b>Scan Genetic Key</b> on the passport. The <b>Wanted Database</b> box (below the docs) auto-fills; click <b>Check</b> to verify.</p>
          <p>Quarantine levels: <b>None</b> (ok), <b>Level‑1</b> (ok if other docs are valid), <b>Level‑2</b> or <b>Biohazard</b> (DETAIN).</p>
        </div>
      </div>
    </div>

    <!-- Upgrades Shop Modal -->
    <div class="modal" id="shop" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999">
      <div class="modalCard" style="width:min(760px,92vw);max-height:80vh;background:#0f1626;border:1px solid #1f2a44;border-radius:12px;box-shadow:0 18px 60px #000a;display:flex;flex-direction:column">
        <div class="modalHead" style="display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #1f2a44">
          <strong>Dock Upgrades</strong>
          <button class="closeX" id="shop-close" style="cursor:pointer;border:1px solid #1f2a44;border-radius:8px;background:#121a2b;padding:4px 8px;color:#e6f0ff">✕</button>
        </div>
        <div class="modalBody" style="padding:12px;overflow:auto;color:#cfe1ff">
          <div id="shop-list" style="display:grid;grid-template-columns:1fr;gap:10px"></div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(function(){
  // --- Game State ---
  const SAVE_KEY = 'alien_checkpoint_save_v4';
  const RANKS = [
    {name:'Recruit', xp:0},
    {name:'Officer', xp:120},
    {name:'Inspector', xp:300},
    {name:'Controller', xp:600},
    {name:'Adjudicator', xp:1000}
  ];

  let state = {
    day: 1,
    credits: 0,
    strikes: 0,
    xp: 0,
    inDay:false,
    queue:[],
    current:null,
    seed: Math.floor(Math.random()*1e9),
    upgrades:{ pay:0, shield:false, queuePlus:0 },
    shieldUsed:false
  };

  // Wanted registry seeded each session
  const wantedRegistry = new Set();
  function genGK(){return 'GK'+Math.floor(100000 + Math.random()*900000)}
  wantedRegistry.add(genGK());
  wantedRegistry.add(genGK());

  // --- Utilities ---
  const byId = id=>document.getElementById(id);
  const log = (msg)=>{ const el=byId('log'); const p=document.createElement('p'); p.textContent=msg; el.prepend(p); };
  const toast=(m)=>{const t=byId('toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',1500)}
  function save(){ localStorage.setItem(SAVE_KEY, JSON.stringify({ day:state.day, credits:state.credits, xp:state.xp, upgrades:state.upgrades })); }
  function loadSave(){ try{ const s=JSON.parse(localStorage.getItem(SAVE_KEY)||'null'); if(s){ state.day=s.day||1; state.credits=s.credits||0; state.xp=s.xp||0; state.upgrades = s.upgrades || {pay:0,shield:false,queuePlus:0}; } }catch(e){} }
  function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
  function fmtMDY(s){ if(!s) return '—'; const [y,m,d]=s.split('-'); return `${m}-${d}-${y}` }
  function todayMDY(){ const d=new Date(); return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}-${d.getFullYear()}`; }
  byId('ui-date').textContent = todayMDY();

  function rand(){ // Mulberry32 PRNG
    state.seed = (state.seed + 0x6D2B79F5) >>> 0; let t = state.seed;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
  const pick = arr => arr[Math.floor(rand()*arr.length)];
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

  // --- Content ---
  const SPECIES = [
    {name:'Zerulon', planets:['Aurex','Klyntar']},
    {name:'Myridian', planets:['Doros','Myra-2']},
    {name:'Vorx', planets:['Hask','Vortex-9']},
    {name:'Eldari', planets:['Solace','Nyelle']},
    {name:'Gubb', planets:['Pudra']}
  ];
  const PURPOSES = ['Transit','Trade','Tourism','Work','Diplomacy'];
  const DURATIONS = ['1 day','3 days','7 days','14 days','30 days'];
  const HEADS = ['round','tall','wide','tri'];
  const MARKINGS = ['none','stripes','spots','chevrons'];

  function pad(n){return String(n).padStart(2,'0')}

  function makeFeatures(){
    return { eyes:1+Math.floor(rand()*5), arms:2+Math.floor(rand()*4), antennae:Math.floor(rand()*3), head:pick(HEADS), tint:`hsl(${Math.floor(rand()*360)} 70% 65%)`, markings:pick(MARKINGS)};
  }

  function renderAlienSVG(f){
    const w=72,h=72,cx=36; const headPath = { round:`M18,18 a18,18 0 1,0 36,0 a18,18 0 1,0 -36,0`, tall:`M24,14 h24 a8,12 0 0,1 8,12 v12 a20,16 0 0,1 -40,0 v-12 a8,12 0 0,1 8,-12 z`, wide:`M16,24 h40 a8,10 0 0,1 0,20 h-40 a8,10 0 0,1 0,-20 z`, tri:`M36,14 L56,44 H16 Z` }[f.head];
    const eyes = Array.from({length:f.eyes},(_,i)=>{ const spread=Math.min(12,4*(f.eyes-1)); const x=cx-spread/2+(i*(spread/(Math.max(1,f.eyes-1)))); return `<circle cx="${x.toFixed(1)}" cy="32" r="3" fill="#111"/>`;}).join('');
    const ants = Array.from({length:f.antennae},(_,i)=>{ const x=cx+(i-(f.antennae-1)/2)*8; return `<path d="M${x},18 q-4,-8 -8,-12" stroke="#333" stroke-width="2" fill="none"/>`;}).join('');
    const mark = f.markings==='none'? '' : (f.markings==='stripes'? `<path d="M22,28 h28 M22,36 h28" stroke="#0005" stroke-width="3"/>` : f.markings==='spots'? `<circle cx="26" cy="30" r="2" fill="#0005"/><circle cx="46" cy="36" r="2" fill="#0005"/>` : `<path d="M24,34 l12,-8 l12,8" stroke="#0005" stroke-width="3" fill="none"/>`);
    const arms = Array.from({length:f.arms},(_,i)=>{ const x=16+i*(40/(f.arms-1||1)); return `<rect x="${x-2}" y="44" width="4" height="14" rx="2" fill="#7aa3"/>`;}).join('');
    const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'><rect width='${w}' height='${h}' fill='white'/><g><rect x='14' y='42' width='44' height='18' rx='8' fill='${f.tint}'/><path d='${headPath}' fill='${f.tint}' stroke='#0004' stroke-width='1'/>${mark}${ants}${eyes}${arms}</g></svg>`;
    return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg);
  }

  function featuresSummary(f){ return `eyes:${f.eyes} | arms:${f.arms} | ant:${f.antennae} | head:${f.head} | mark:${f.markings}`; }

  function maybePhotoMismatch(real){
    const f = JSON.parse(JSON.stringify(real));
    const knob = pick(['eyes','arms','antennae','head','markings']);
    if(knob==='eyes') f.eyes = clamp(f.eyes + (rand()>0.5?1:-1),1,5);
    if(knob==='arms') f.arms = clamp(f.arms + (rand()>0.5?1:-1),2,5);
    if(knob==='antennae') f.antennae = clamp(f.antennae + (rand()>0.5?1:-1),0,2);
    if(knob==='head') f.head = pick(HEADS.filter(h=>h!==f.head));
    if(knob==='markings') f.markings = pick(MARKINGS.filter(m=>m!==f.markings));
    return f;
  }

  function makeBadSeal(){
    const variants=[
      ()=> 'NX-'+(1000+Math.floor(rand()*9000)),           // too many digits
      ()=> (pick(['N','X','Z','M'])+pick(['X','N','Q'])+'-'+(10+Math.floor(rand()*90))), // wrong letters or too few digits
      ()=> 'NX'+(100+Math.floor(rand()*900)),              // missing hyphen
      ()=> 'N'+(rand()>0.5?'':'x')+'-'+(100+Math.floor(rand()*900)), // wrong/missing letter
      ()=> 'NX-'+(100+Math.floor(rand()*900))+(rand()>0.5?'a':'X')   // trailing char
    ];
    return variants[Math.floor(rand()*variants.length)]();
  }

  function makeAlien(){
    const sp = pick(SPECIES);
    const name = pick(['Ryll','Kora','Jent','Zux','Mira','Torv','Plek','Lena','Qir','Brol']) + ' ' + pick(['Zeen','Tark','Vel','Qor','Dax','Meln','Iri','Sorn']);
    const planet = pick(sp.planets);
    const thisYear=(new Date()).getFullYear();
    const birthYear = thisYear - (18 + Math.floor(rand()*80));
    const dob = `${birthYear}-${pad(1+Math.floor(rand()*12))}-${pad(1+Math.floor(rand()*27))}`;
    const expOk = rand()>0.18;
    const exp = expOk? new Date(Date.now() + (2+Math.floor(rand()*30))*86400000).toISOString().slice(0,10)
                      : new Date(Date.now() - (1+Math.floor(rand()*10))*86400000).toISOString().slice(0,10);
    // Sometimes the Visa lists a different planet permit (for mismatch checks)
    let vsPlanet = planet; if(rand()>0.85){ const pool = SPECIES.map(s=>s.planets).reduce((a,b)=>a.concat(b),[]).filter(p=>p!==planet); if(pool.length) vsPlanet = pick(pool); }
    const purpose = pick(PURPOSES);
    const duration = pick(DURATIONS);
    const seal = (rand()>0.2)? ('NX-'+(100+Math.floor(rand()*900))) : makeBadSeal();
    const gk = 'GK'+Math.floor(100000 + rand()*900000);
    const feats = makeFeatures();
    const vsSmudged = rand()>0.85;
    const vsName = vsSmudged ? name.split('').map((c,i)=> i>0 && i<name.length-1 && Math.random()>0.6 ? (c===' ' ? ' ' : '·') : c).join('') : name;
    const photoForged = rand()>0.82;
    const photoFeats = photoForged? maybePhotoMismatch(feats) : JSON.parse(JSON.stringify(feats));
    // Hints & quarantine
    const hints=[]; 
    const qLevels=['None','Level-1','Level-2','Biohazard'];
    const quarantine = rand()>0.9 ? pick(qLevels.slice(1)) : 'None';
    return { sp:sp.name, planet, vsPlanet, name, vsName, vsSmudged, pidName:name, dob, exp, purpose, duration, quarantine, seal, gk, feats, photoFeats, hints, _gkScanned:false, _gkFlagged:false };
  }

  function buildQueue(){
    const base = 5 + Math.floor(state.day/2);
    const extra = (state.upgrades.queuePlus||0)*2;
    state.queue = Array.from({length: base + extra}, ()=>makeAlien());
    state.todayRules = baseRules();
    state.shieldUsed=false;
  }

  function baseRules(){
    return [
      { id:'name', text:'Names must be legible and present on Passport, Visa, and Photo ID and they must match exactly.', check: a => !!a.name && !!a.vsName && !!a.pidName && !a.vsSmudged && a.name===a.vsName && a.name===a.pidName },
      { id:'expiry', text:'Passports must be unexpired (compared to current date).', check: a => new Date(a.exp+'T00:00:00') >= new Date(todayISO()+'T00:00:00') },
      { id:'planet', text:'Planet of Origin must match the Planet Permit on the Visa.', check: a => a.planet===a.vsPlanet },
      { id:'seal', text:'Visa must have a valid security seal (NX-###).', check: a => /^NX-\d{3}$/.test(a.seal) },
      { id:'gk', text:'Genetic Key must not belong to a wanted registry when checked.', check: a => a._gkFlagged !== true },
      { id:'photo', text:'Photo ID must match live portrait features (eyes/arms/antennae/head/markings).', check: a => a.feats.eyes===a.photoFeats.eyes && a.feats.arms===a.photoFeats.arms && a.feats.antennae===a.photoFeats.antennae && a.feats.head===a.photoFeats.head && a.feats.markings===a.photoFeats.markings }
    ];
  }

  // --- UI ---
  function renderHeader(){
    byId('ui-day').textContent = state.day;
    byId('ui-credits').textContent = state.credits;
    byId('ui-strikes').textContent = state.strikes;
    const rank = RANKS.reduce((acc,r)=> state.xp>=r.xp? r:acc, RANKS[0]);
    byId('ui-rank').textContent = rank.name;
    const next = RANKS.find(r=>r.xp>state.xp);
    const pct = next? ( (state.xp - rank.xp) / (next.xp - rank.xp) * 100) : 100;
    byId('xpbar').style.width = Math.min(100,Math.max(0,pct))+'%';
  }

  // SAFE: tolerate undefined todayRules on first render
  function renderRules(){
    const box=byId('rules');
    box.innerHTML='';
    const rules = state.todayRules || (state.todayRules = baseRules());
    rules.forEach(r=>{ const d=document.createElement('div'); d.className='rule'; d.innerHTML = `<b>Rule:</b> ${r.text}`; box.appendChild(d); });
  }

  // SAFE: tolerate undefined queue
  function renderQueue(){
    const q=byId('queue'); q.innerHTML='';
    const list = Array.isArray(state.queue) ? state.queue : [];
    list.forEach(a=>{ const card=document.createElement('div'); card.className='alienCard'; const thumb=renderAlienSVG(a.feats); card.innerHTML=`<div class="alienPic"><img src="${thumb}" alt="thumb" style="width:100%;height:100%;object-fit:cover"/></div><div><div><b>${a.name}</b> — ${a.sp}</div><div class="alienMeta">${a.planet} • ${a.purpose} • ${a.duration}</div></div>`; q.appendChild(card); });
  }

  function showDoc(a){
    byId('pp-species').textContent = a.sp; byId('pp-name').textContent = a.name; byId('pp-planet').textContent = a.planet; byId('pp-dob').textContent = fmtMDY(a.dob); byId('pp-exp').textContent = fmtMDY(a.exp); byId('pp-gk').textContent = a.gk;
    const vsNameCell = byId('vs-name'); vsNameCell.textContent = (a.vsName && a.vsName.trim()) ? a.vsName : '—'; vsNameCell.classList.toggle('illegible', !!a.vsSmudged); vsNameCell.title = a.vsSmudged ? 'Visa name appears smudged/illegible' : '';
    byId('vs-purpose').textContent = a.purpose; byId('vs-duration').textContent = a.duration; byId('vs-planet').textContent = a.vsPlanet; byId('vs-quar').textContent = a.quarantine; byId('vs-seal').textContent = a.seal;
    const liveURL = renderAlienSVG(a.feats); const photoURL = renderAlienSVG(a.photoFeats); byId('pp-live').src = liveURL; byId('pid-photo').src = photoURL; byId('pid-name').textContent = a.pidName || a.name; byId('pid-caption').textContent = 'Dockyard archive photo on arrival'; byId('pp-feats').textContent = featuresSummary(a.feats); byId('pid-feats').textContent = featuresSummary(a.photoFeats);
    ['pp-stamp','vs-stamp','pid-stamp'].forEach(id=>byId(id).style.opacity=0);
  }

  function setDecisionButtons(disabled){ ['approve','deny','detain'].forEach(id=>{ const b=byId(id); if(b){ b.disabled=disabled; b.style.opacity = disabled ? 0.6 : 1; } }); }

  function popNext(){
    const input=byId('manual-gk'); if(input) input.value='';
    if(!state.queue || !state.queue.length){ state.current=null; log('Queue empty. End the day to proceed.'); setDecisionButtons(true); return; }
    state.current = state.queue.shift();
    state.current._resolved=false; setDecisionButtons(false);
    renderQueue(); showDoc(state.current); log(`Next ship: ${state.current.name} (${state.current.sp}) from ${state.current.planet}`);
  }

  // Scanner & manual wanted check
  function scanGK(){
    const a=state.current; if(!a){toast('No ship selected'); return;}
    a._gkScanned=true; const flagged = wantedRegistry.has(a.gk); a._gkFlagged = flagged;
    byId('pp-gk').textContent = a.gk + (flagged ? ' (WANTED)' : '');
    const input=byId('manual-gk'); if(input){ input.value=a.gk; }
    log('*SCANNER*: '+a.gk+(flagged?' — WANTED':' — CLEAR'));
    toast(flagged? 'WANTED genetic match!' : 'Genetic code scanned — clear');
  }
  function manualCheck(){ const code = byId('manual-gk').value.trim(); if(!code){ toast('Type a genetic code to check'); return; } const flagged = wantedRegistry.has(code); if(!state.current){ toast('No current applicant'); return; } if(flagged){ state.current._gkFlagged = true; byId('pp-gk').textContent = state.current.gk + ' (WANTED)'; log('Manual check: '+code+' flagged'); toast('Manual check: WANTED'); } else { log('Manual check: '+code+' not found'); toast('Manual check: not found'); } }

  // Adjudication
  function evaluate(answer){ if(!state.current){ toast('No ship selected'); return; } const a=state.current; if(a._resolved){ toast('Decision already recorded'); return; }
    const failures = (state.todayRules||baseRules()).filter(r=>!r.check(a)); const quarantineHeavy = ['Level-2','Biohazard'].includes(a.quarantine); const wanted = !!a._gkFlagged; const correctDecision = wanted || quarantineHeavy ? 'DETAIN' : (failures.length===0 ? 'APPROVE' : 'DENY');
    const ppStamp = byId('pp-stamp'); const vsStamp = byId('vs-stamp'); const pidStamp = byId('pid-stamp');
    if(answer==='APPROVE'){ vsStamp.style.opacity=1; vsStamp.textContent='APPROVED'; vsStamp.classList.add('ok'); }
    if(answer==='DENY'){ ppStamp.style.opacity=1; ppStamp.textContent='DENIED'; ppStamp.classList.remove('ok'); }
    if(answer==='DETAIN'){ ppStamp.style.opacity=1; ppStamp.textContent='DETAINED'; ppStamp.classList.remove('ok'); }
    if(a.feats.eyes!==a.photoFeats.eyes || a.feats.arms!==a.photoFeats.arms || a.feats.antennae!==a.photoFeats.antennae || a.feats.head!==a.photoFeats.head || a.feats.markings!==a.photoFeats.markings){ pidStamp.style.opacity=0.3; }
    let delta=0, xp=0; const payBonus = state.upgrades.pay||0; if(answer===correctDecision){ delta=5+Math.max(0,3-failures.length)+payBonus; xp=15; state.credits+=delta; state.xp+=xp; log('✔ Correct: '+answer+' • +'+delta+' credits'); toast('Correct (+'+delta+'₵, +'+xp+'xp)'); } else {
      if(state.upgrades.shield && !state.shieldUsed){ state.shieldUsed=true; log('✖ Wrong (shielded): chose '+answer+' expected '+correctDecision); toast('Shield absorbed the strike'); }
      else { state.credits-=3; state.strikes++; log('✖ Wrong: chose '+answer+' expected '+correctDecision+' • -3 credits'); toast('Incorrect (−3₵) • Strike '+state.strikes); if(state.strikes>=3){ endDay('Too many strikes. Shift ended.'); a._resolved=true; setDecisionButtons(true); return; } }
    }
    a._resolved=true; setDecisionButtons(true); renderHeader(); }

  function endDay(reason){ state.inDay=false; byId('btn-newday').textContent='Start Day'; if(reason) log('Day ended: '+reason); const input=byId('manual-gk'); if(input) input.value=''; save(); renderHeader(); }

  // Handlers
  byId('approve').addEventListener('click',()=>evaluate('APPROVE'));
  byId('deny').addEventListener('click',()=>evaluate('DENY'));
  byId('detain').addEventListener('click',()=>evaluate('DETAIN'));
  byId('next').addEventListener('click',popNext);
  byId('scan-gk').addEventListener('click',scanGK);
  byId('check-gk').addEventListener('click',manualCheck);

  document.addEventListener('keydown',e=>{ if(e.key==='a'||e.key==='A') evaluate('APPROVE'); if(e.key==='d'||e.key==='D') evaluate('DENY'); if(e.key==='f'||e.key==='F') evaluate('DETAIN'); if(e.key==='n'||e.key==='N') popNext(); if(e.code==='Space'){ e.preventDefault(); byId('btn-newday').click(); } });

  byId('btn-newday').addEventListener('click',()=>{ if(state.inDay){ endDay('You ended the day.'); return; } state.inDay=true; state.strikes=0; byId('btn-newday').textContent='End Day'; buildQueue(); renderRules(); renderQueue(); popNext(); log('Day '+state.day+' started'); save(); });
  byId('btn-reset').addEventListener('click',()=>{ if(confirm('Reset progress?')){ localStorage.removeItem(SAVE_KEY); location.reload(); } });

  // Manual modal handlers
  const manualEl = document.getElementById('manual');
  const manualBtn = document.getElementById('btn-manual');
  if(manualBtn){ manualBtn.addEventListener('click',()=>{ manualEl.style.display='flex'; }); }
  const manualClose = document.getElementById('manual-close');
  if(manualClose){ manualClose.addEventListener('click',()=>{ manualEl.style.display='none'; }); }
  manualEl.addEventListener('click',e=>{ if(e.target===manualEl) manualEl.style.display='none'; });

  // Shop modal + upgrades
  const shopEl = document.getElementById('shop');
  const shopBtn = document.getElementById('btn-shop');
  const shopClose = document.getElementById('shop-close');
  const SHOP_ITEMS = [
    {id:'pay', name:'Paygrade Boost', desc:'+1 credit on correct decisions (stacks up to +3).', cost:[30,60,90], type:'level', max:3},
    {id:'shield', name:'Shielded Clause', desc:'Ignore the first strike and credit penalty each day.', cost:[50], type:'flag', max:1},
    {id:'queuePlus', name:'Queue Extender', desc:'Adds +2 ships per day (max +4).', cost:[25,40], type:'level', max:2}
  ];
  function renderShop(){
    const list=document.getElementById('shop-list'); list.innerHTML='';
    SHOP_ITEMS.forEach(it=>{
      const level = (it.id==='shield') ? (state.upgrades.shield?1:0) : (state.upgrades[it.id]||0);
      const owned = it.type==='flag' ? !!state.upgrades[it.id] : level;
      const atMax = it.type==='flag'? owned : level>=it.max;
      const price = it.type==='flag'? it.cost[0] : it.cost[Math.min(level, it.cost.length-1)];
      const affordable = state.credits>=price && !atMax;
      const row=document.createElement('div'); row.className='hammer';
      row.innerHTML = `<div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
        <div><div style="font-weight:700">${it.name}${it.type==='level'?' (Lv.'+level+'/'+it.max+')':''}</div>
        <div class="muted">${it.desc}</div></div>
        <div class="flex" style="gap:8px">
          <div class="chip">Cost: ${price}₵</div>
          <button class="btn" data-id="${it.id}" ${(!affordable?'disabled':'')}>${atMax?'Maxed':'Buy'}</button>
        </div>
      </div>`;
      list.appendChild(row);
    });
    list.querySelectorAll('button[data-id]').forEach(b=> b.onclick=()=>buyUpgrade(b.getAttribute('data-id')) );
  }
  function buyUpgrade(id){
    const it = SHOP_ITEMS.find(x=>x.id===id); if(!it) return;
    let level = (id==='shield')?(state.upgrades.shield?1:0):(state.upgrades[id]||0);
    const atMax = it.type==='flag'? !!level : level>=it.max; if(atMax){ toast('Already maxed'); return; }
    const price = it.type==='flag'? it.cost[0] : it.cost[Math.min(level, it.cost.length-1)];
    if(state.credits<price){ toast('Not enough credits'); return; }
    state.credits-=price; if(id==='shield'){ state.upgrades.shield=true; } else { state.upgrades[id]=(level+1); }
    save(); renderHeader(); renderShop(); toast('Purchased: '+it.name);
  }
  if(shopBtn){ shopBtn.addEventListener('click',()=>{ renderShop(); shopEl.style.display='flex'; }); }
  if(shopClose){ shopClose.addEventListener('click',()=>{ shopEl.style.display='none'; }); }
  shopEl.addEventListener('click',e=>{ if(e.target===shopEl) shopEl.style.display='none'; });

  // (Optional) click-to-zoom portraits
  const lb=document.getElementById('lightbox'); const lbImg=document.getElementById('lightbox-img');
  function enableZoom(img){ img.addEventListener('click',()=>{ lbImg.src=img.src; lb.style.display='flex'; }); }
  lb.addEventListener('click',()=>{ lb.style.display='none'; lbImg.src=''; });
  ['pp-live','pid-photo'].forEach(id=>{ const el=byId(id); if(el) enableZoom(el); });

  // --- Self-tests (kept) + NEW tests for regressions ---
  function runTests(){
    const rules = baseRules();
    const ok = makeAlien(); // valid-ish
    ok.vsSmudged=false; ok.vsName=ok.name; ok.photoFeats=JSON.parse(JSON.stringify(ok.feats)); ok.seal='NX-123'; ok.exp=new Date(Date.now()+86400000).toISOString().slice(0,10); ok.vsPlanet = ok.planet; ok.quarantine='None'; ok._gkFlagged=false;
    const assert=(name,cond)=>{ log((cond?'[TEST PASS] ':'[TEST FAIL] ')+name); };
    assert('name match', rules.find(r=>r.id==='name').check(ok));
    assert('expiry future', rules.find(r=>r.id==='expiry').check(ok));
    assert('planet match', rules.find(r=>r.id==='planet').check(ok));
    assert('seal valid', rules.find(r=>r.id==='seal').check(ok));
    // negatives
    const bad1={...ok, exp:new Date(Date.now()-86400000).toISOString().slice(0,10)}; assert('expiry rule fails on past', !rules.find(r=>r.id==='expiry').check(bad1));
    const bad2={...ok, seal:'NX-1234'}; assert('seal rejects extra digit', !rules.find(r=>r.id==='seal').check(bad2));
    const allPlanets = SPECIES.map(s=>s.planets).reduce((a,b)=>a.concat(b),[]); const otherP = allPlanets.find(p=>p!==ok.planet) || 'Otheria'; const bad3={...ok, vsPlanet:otherP}; assert('planet mismatch fails', !rules.find(r=>r.id==='planet').check(bad3));
    const bad4={...ok, _gkFlagged:true}; assert('wanted GK fails', !rules.find(r=>r.id==='gk').check(bad4));
    const bad5={...ok, photoFeats:{...ok.photoFeats, arms:ok.photoFeats.arms+1}}; assert('photo mismatch fails', !rules.find(r=>r.id==='photo').check(bad5));

    // NEW: evaluate idempotent (no farming)
    const savedCredits = state.credits; const savedXP = state.xp; state.current = JSON.parse(JSON.stringify(ok)); state.current._resolved=false; showDoc(state.current);
    evaluate('APPROVE'); evaluate('APPROVE');
    assert('evaluate processed only once', (state.credits - savedCredits) > 0 && (state.credits - savedCredits) < 20 && (state.xp - savedXP) === 15);

    // NEW: shop purchase applies and charges credits
    const preC = state.credits; state.credits = 100; state.upgrades.pay=0; buyUpgrade('pay'); assert('shop deducts credits and increases pay level', state.credits===70 && state.upgrades.pay===1);

    // NEW: renderRules tolerates undefined todayRules
    const oldRules = state.todayRules; delete state.todayRules; try{ renderRules(); assert('renderRules with undefined todayRules does not crash', true); }catch(e){ assert('renderRules with undefined todayRules does not crash', false); } finally { state.todayRules = oldRules || baseRules(); }

    // NEW: renderQueue tolerates undefined queue
    const oldQ = state.queue; delete state.queue; try{ renderQueue(); assert('renderQueue with undefined queue does not crash', true); }catch(e){ assert('renderQueue with undefined queue does not crash', false); } finally { state.queue = oldQ; renderQueue(); }

    // NEW: popNext on empty queue safe
    const savedQ = state.queue; state.queue = []; try{ popNext(); assert('popNext on empty queue handled', true);}catch(e){ assert('popNext on empty queue handled', false);} finally { state.queue = savedQ; }

    // NEW: date format helper
    assert('fmtMDY formats ISO to MM-DD-YYYY', fmtMDY('2025-10-07')==='10-07-2025');
  }

  // Boot
  loadSave(); renderHeader(); state.queue = Array.from({length:5}, ()=>makeAlien()); renderRules(); renderQueue(); runTests();
})();
</script>
</body>
</html>
